CREATE DATABASE RestauranteDB;
USE RestauranteDB;

CREATE TABLE Clientes (
    ID_Cliente INT PRIMARY KEY AUTO_INCREMENT,
    Nome VARCHAR(100) NOT NULL,
    Telefone VARCHAR(20),
    Email VARCHAR(100)
);

CREATE TABLE Funcionarios (
    ID_Funcionario INT PRIMARY KEY AUTO_INCREMENT,
    Nome VARCHAR(100) NOT NULL,
    Cargo VARCHAR(50) NOT NULL,
    Telefone VARCHAR(20),
    Salario DECIMAL(10,2)
);

CREATE TABLE Produtos (
    ID_Produto INT PRIMARY KEY AUTO_INCREMENT,
    Nome VARCHAR(100) NOT NULL,
    Categoria VARCHAR(50) NOT NULL,
    Preco DECIMAL(10,2) NOT NULL,
    Ativo BOOLEAN DEFAULT TRUE
);

CREATE TABLE Pedidos (
    ID_Pedido INT PRIMARY KEY AUTO_INCREMENT,
    ID_Funcionario INT,
    ID_Cliente INT,
    Valor DECIMAL(10,2),
    Data_Pedido DATETIME DEFAULT CURRENT_TIMESTAMP,
    Status ENUM('Aberto', 'Em Preparo', 'Finalizado', 'Cancelado') DEFAULT 'Aberto',
    FOREIGN KEY (ID_Funcionario) REFERENCES Funcionarios(ID_Funcionario),
    FOREIGN KEY (ID_Cliente) REFERENCES Clientes(ID_Cliente)
);

CREATE TABLE Pedido_Itens (
    ID_Pedido INT,
    ID_Produto INT,
    Quantidade INT NOT NULL DEFAULT 1,
    Preco_Unitario DECIMAL(10,2) NOT NULL,
    PRIMARY KEY (ID_Pedido, ID_Produto),
    FOREIGN KEY (ID_Pedido) REFERENCES Pedidos(ID_Pedido),
    FOREIGN KEY (ID_Produto) REFERENCES Produtos(ID_Produto)
);

INSERT INTO Produtos (Nome, Categoria, Preco) VALUES
('Pizza Calabresa', 'Pizza', 45.90),
('Pizza Frango c/ Catupiry', 'Pizza', 49.90),
('Coca-Cola 2L', 'Bebida', 10.90),
('Guaraná 2L', 'Bebida', 9.90),
('Água 500ml', 'Bebida', 3.50);

DELIMITER //

CREATE PROCEDURE RegistrarPedidoSimples(
    IN p_ID_Funcionario INT,
    IN p_ID_Cliente INT,
    IN p_ID_Produto INT,
    IN p_Quantidade INT
)
BEGIN
    DECLARE v_ID_Pedido INT;
    DECLARE v_Preco DECIMAL(10,2);
    DECLARE v_Total DECIMAL(10,2);

    SELECT Preco INTO v_Preco FROM Produtos WHERE ID_Produto = p_ID_Produto;
    SET v_Total = v_Preco * p_Quantidade;

    INSERT INTO Pedidos (ID_Funcionario, ID_Cliente, Valor)
    VALUES (p_ID_Funcionario, p_ID_Cliente, v_Total);

    SET v_ID_Pedido = LAST_INSERT_ID();

    INSERT INTO Pedido_Itens (ID_Pedido, ID_Produto, Quantidade, Preco_Unitario)
    VALUES (v_ID_Pedido, p_ID_Produto, p_Quantidade, v_Preco);

    SELECT v_ID_Pedido AS PedidoID, v_Total AS Total;
END //

DELIMITER ;
